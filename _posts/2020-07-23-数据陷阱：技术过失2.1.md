---
layout:     post
title:      数据陷阱：技术过失2.1
subtitle:   陷阱：汇总失衡
date:       2020-07-23
author:     刘政永Dmer
header-img: img/post-bg-dmers.jpg
catalog: true
tags:
    - 听取树蛙一篇
---

## 陷阱：汇总失衡

当对具有相同属性的数据记录进行分组时，就会涉及数据聚合或汇总。在实际生活中，有各种各样的这种分类。有时数据分组会形成层次结构。以下是一些例子:

1.时间: 小时、日、周、月、年
2.地理: 城市、县、州、国家
3.组织: 员工、团队、部门、公司
4.运动: 团队、分区、会议、联盟
5.产品: SKU，产品类型，品类，品牌

无论我们是在报告不同级别的销售状况，还是为商业活动统计投票，这些汇总计算对我们的报告的完成度都至关重要。让我们来看一个来自航空领域的例子。

美国联邦航空管理局(The U.S. Federal Aviation Administration)鼓励飞行员自愿报告他们的飞机在起飞、飞行、接近或降落时撞击野生动物的情况。 显然，从飞行员、乘客，尤其是那些可怜的小动物的角度来看，挺没劲的。而这个数据向公众开放，为了让大家对此有所感知。

从这些记录中摘录了一个特定的部分（数据源来自https://wildlife.faa.gov/)。我们看下上报的野生动物袭击的数量是如何随着时间变化的，当然前提是如果有的话。这里做了张撞击记录的时间线图，按年计算，如下所示：

![]({{site.baseurl}}/img/post-bg-hz1.jpg)

从这个时间轴上可以看到，该数据记录可追溯到2000年。这图这似乎表明，上报的撞击事件呈上升趋势， 然后在有数据显示的最近一年（相对于当时写这个分析报告的时间），即2017年，出现了急剧下降。为什么撞击数量突然减少了? 是否有一些高新技术在全美各地的机场实施?鸟类和动物的大规模南迁?负责管理数据的美国联邦航空局员工罢工了?

其实答案不难找到，将数据集的粒度级别精确到月或周， 可以看到2017年的数据只有半年的，如下所示：

![]({{site.baseurl}}/img/post-bg-hz2.jpg)

确切地说，当时做这个分析报告时，该数据集中最新记录的野生动物撞击发生在2017年7月31日晚上11点55分。 有记录的最早的撞击发生在2000年1月1日上午9点43分。 这是上报撞击事件的日期方面的范围，也是一个简单但重要的陷阱预警:将层次不同的数据按同一层次汇总。

这提醒我们，在得出任何关于数据的结论之前，一定要花一点时间找出正在分析的数据的边界 ，至少先找出数据集中每个定量维度的最小值和最大值。

可以想象，处理新数据集类似来到一个未知的岛屿，比如波利尼西亚人在700年前首次发现并定居新西兰，后来成为毛利人。 或者类似于探险家詹姆斯·库克(James Cook)，他在1769年末至1770年初来到那里，是第一个完成了环绕毛利人家乡对面那个岛屿的欧洲人。

![]({{site.baseurl}}/img/post-bg-hz3.jpg)

有趣的是，库克并不是第一个发现新西兰的欧洲人。在他之前的一个世纪，1642年，荷兰航海家亚伯·塔斯曼(Abel Tasman)驾驶着Zeehaen号船已经发现了，但他没有像库克那样彻底地绕过，也没有彻底地探索其海岸。 这就是为什么库克的探险队能够正确地将新西兰南部和北部岛屿之间的区域识别为一个海峡，因而这是一个可航行的航道，而不是一个海湾；可是当时那个荷兰人错误地认为这是仅仅是一个没有通道的弯曲的海岸线。这就是为什么新西兰南岛和北岛之间的那片区域被称为库克海峡， 而不是塔斯曼最初命名的齐海恩湾。这是一个很好的实例，因为它展示了：当我们不能彻底地探索航海目标的轮廓时，很可能会得出关于地形的错误结论，做数据工作也是如此。

这段历史典故讲罢，回到刚才提及的野生动物撞击飞机的数据集。如果已经看到了2017年撞击数据的陡降，不作多想，还是认定这是2017年的全年数据，就太不应该了。 每次给一些新受众展示这个报告时，对于2017年的这个突然下降的撞击数，很多人都会狐疑不决，脑洞大开，即使已经事先提醒这个是已上报的数据。相信一直跟着看这个系列的朋友， 应该看出来了，这里面又涉及了认知方面的陷阱，即数据与现实的差距，也就是错误的认定标识为2017的数据包含了2017年的全部数据。

期待大家在汇总多层次数据集时，对此保持谨慎。

如果我们想探究野生动物撞击的季节性会怎样?例如，撞击是否经常发生在冬季还是夏季? 如果没有首先探索轮廓数据而去寻求这个问题的答案,一般会先看下按月汇总的数据，作图如下：

![]({{site.baseurl}}/img/post-bg-hz4.jpg)

首先观察到的可能是，撞击次数最多的月份是7月，在冬季12月达到了最低水平，

1月、2月，然后在春季缓慢增加，5月至6月略有下降，然后在7月飙升至峰值。在这个高峰之后，计数逐月稳步下降。

通过之前对数据轮廓的研究，我们已经知道，这些记录在2017年7月31日结束， 所以1月到7月的数据比8月到12月多了一个月。如果我们在每个月的条形图上加上年度的部分—— 每年一个带有数据的部分——并且只把2017年的部分涂成红色，就会发现，每个月的比较并不是严格意义上的一对一比较。如下图：

![]({{site.baseurl}}/img/post-bg-hz5.jpg)

1月,2月,3月,4月,5月,6月和7月都包括18种不同年份的数据,和其他月份包括17个不同的年, 因为2017年只有部分数据。如果过滤掉2017的数据, 在上图中意味着去掉红色部分从,而每个月度包含数据相同年数。 如此看来，7月份实际上并不是上报撞击次数最多的月份，而是8月份，如下图所示

![]({{site.baseurl}}/img/post-bg-hz6.jpg)

如果我们贸然作一个快速和粗略的分析，认定7月是高峰月份，就会像亚伯塔斯曼航行离开库克海峡， 认定前方无路可走是一样的。说来可悲，已不知有多少次，数据从业者因为忽略了数据集的边界，而在基本事实上犯了错误。

本文转载于知乎海数据实验室。