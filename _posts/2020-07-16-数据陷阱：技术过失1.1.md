---
layout:     post
title:      数据陷阱：技术过失1.1
subtitle:   脏数据陷阱
date:       2020-07-16
author:     刘政永Dmer
header-img: img/post-bg-dmers.jpg
catalog: true
tags:
    - 听取树蛙一篇
---

提起脏数据，不禁要问，到底怎么个“脏”法呢。实言告汝，真的是脏得千奇百怪，如拼写错误的文本值、日期格式问题、 不匹配的单位、缺失值、空值、不兼容的地理空间坐标格式，等等，不胜枚举。 正如ggplot2（R语言中的数据可视化包）的作者Hadley Wickham在他的R for Data Science一书中所阐述的---他修改了列夫·托尔斯泰( Leo Tolstoy)的一句名言:“整洁的数据集都是相似的， 但每一个凌乱的数据集都有其各自的凌乱之处。”

在网上，有些从政府部门免费下载的公开数据会有特别脏的。 让我们使用一个有趣的数据集:汽车拖车数据。 美国马里兰州巴尔的摩市交通局提供了从2017年1月到2012年10月的61300多起拖车事件的数据。 下图显示了最早的拖车事件的前11列。如下图所示。

![]({{site.baseurl}}/img/post-bg-zs1.jpg)

看到这个表格的数据，很常规的样子，似乎拖拽几次，摆弄一番就妥了。每一辆车都有生产年份（vehicleYear），拖车场的朋友们也记录了这个数据。 我想知道在巴尔的摩被拖走的汽车的大致生产年份在什么时候，就计算了这里数据的平均汽车年份，四舍五入，然后我得到的数字是23--显然这列数据有问题。

这看起来很奇怪。肯定不是1923年，2023年也不可能。这是怎么回事?平均车辆制造年份怎么会是23?于此我们先带着这个疑情。

让我们再仔细看看，就像平时处理数据一样。不难看出：车辆年份这个维度在从拖车场的人工记录到数字表格记录的处理过程中还是有变化的。

扫一眼电子表格中的vehicleYear列，就会发现有一些严重的问题：第一个值是99，大概是1999。下一个值是91，我们可以假设这辆车的年份很可能是1991年。 但是第三行4的值呢?似乎应该是2004年。此外，还有一个空白单元格和一个“?”： 前者或许是记录拖车的人没有记录，后者或许只是不知道车辆年份? 这些值可能有不止一种含义。

让我们暂停于此，考虑一下收集和存储此数据所涉及的过程。听一些在美国有拖车经历的人说过记录的一般方式：来一个记录员，拿个本子和笔，问答记录，至于记成什么样子，无从知道。 而且对于谁把这些信息输入了电脑，用什么软件生成了相关表格，更加无从得知。很多信息都在数据处理和转换中丢失了，很明显可以看出，多年前的历史数据也没有进行必要的备份。

当然，我们需要对拖车司机和拖车场的数据录入员表示理解。如果我必须像这样输入超过61,000行，错误也少不了。 那么，在定量的背景下，我们该如何处理和调整这个混乱拖车车辆的年份呢?请看下面的直方图，根据刚才谈及的数据集所作。

![]({{site.baseurl}}/img/post-bg-zs2.jpg)

我们可以清楚地看到有两组，而且乍一看中间似乎没有什么东西。左边的第一组车辆年值在0到17之间。可以猜测这些车是在2000年到2017年之间制造的。第二组有vehicleYear值在82和99之间；很可能是在1982年到1999年之间建造的。再者这里，我们可以调整车辆年年份，在0到17岁之间的车辆年份数值加上2000年，19以上的年份加上2000年（按：这个分析报告最初是在2019年所作）。

数据经过调整后的图如下所示。

![]({{site.baseurl}}/img/post-bg-zs3.jpg)

这个看起来好多了!但还没有结束。通常，第一次调整或校正是主体调整，还需要更多的微调。 正如我们可以用拖把拖地板，但有时需要回过头来用清洁剂来擦很难擦的污渍。这个数据集也需要如此处理。

如下图，我们可以看到修正后的车辆年直方图在左边有一个很长的尾巴。看起来好像什么都没有， 但实际上，1920(最初20)、1940(最初40)、1960(最初60)和1963(最初63)的单个值都有很短的条形图。 被拖走的真的是旧车吗?

![]({{site.baseurl}}/img/post-bg-zs4.jpg)

现在,可以很确定,“丰田Camray”(原表就是这么记的)实际上是丰田凯美瑞(Toyota Camry)，不可能是1920年的,因为丰田公司1982年才开始生产这种车辆。 沃尔沃S40(VolvoS40)绝对不可能是从1940的,但是可以猜测这可能是S40里面的“40”的导致的。 吉普自由人(JeepLiberty)不可能是1960年的，因为这种车生产于2002-2012年。 1963年的“凯迪拉克轿车德维尔(Cadillac SedanDeville)”很可能是1963年凯迪拉克轿车德维尔(Cadillac Sedan deVille)，这个年份值应该是正确的。剩下的三个明显都是是错误的年份值，该怎么办呢?把它们过滤掉吗?是否需要做更多的研究找出它们实际的年份?能让他们保持原样吗?

这在很大程度上取决于分析工作的需要，以及这些价值是否会对研究产生显著影响。 正如我们稍后将讨论的，离群值会对平均值(算术平均值)产生很大的影响，因此应该慎重选择， 并且应该对所做的任何调整或任何明显错误的值留进行详细注释。

现在，先把这四个离群值保留在数据集中，重新计算平均车辆年份，经过四舍五入，为2005， 这似乎比23更合理，不是吗?移除这四个离群值只会使计算出的平均值每年改变千分之一，并且在四舍五入取整时，它会完全消失。 所以我觉得把这四个数字留在我的分析里，即使我很确定有些问题的，不过这对我从数据中发掘洞见（insight）没有实质性的影响。

说到这一洞见，不得不道个歉，刚才的例子有点无聊：平均拖车车辆年能告诉我们什么呢?虽然2005这个统计数据很有趣，但它有点误导人，时间跨度太大，会使得有些车不在目标范围。 比如，你可不能在2014年拖一辆2017年的别克。所以更有意义的是，每两年内获得平均车辆年份，然后跟踪这个平均值随时间的变化。 在接下来的章节中，我们将会有更多关于平均值的讨论。

本文转载于知乎海数据实验室。